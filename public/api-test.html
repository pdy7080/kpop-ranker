<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸš¨ KPOP Ranker API í…ŒìŠ¤íŠ¸</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            background: #f0f0f0; 
            line-height: 1.6;
        }
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
            background: white; 
            padding: 20px; 
            border-radius: 10px; 
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        .test-section { 
            margin: 20px 0; 
            padding: 15px; 
            border: 1px solid #ddd; 
            border-radius: 5px; 
        }
        .success { 
            color: green; 
            background: #f0f8f0; 
        }
        .error { 
            color: red; 
            background: #f8f0f0; 
        }
        .info { 
            color: blue; 
            background: #f0f0f8; 
        }
        button { 
            padding: 10px 20px; 
            margin: 5px; 
            background: #007bff; 
            color: white; 
            border: none; 
            border-radius: 5px; 
            cursor: pointer; 
        }
        button:hover { 
            background: #0056b3; 
        }
        .result { 
            margin: 10px 0; 
            padding: 10px; 
            border-radius: 5px; 
            white-space: pre-wrap; 
            font-family: monospace; 
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
        }
        .image-test { 
            display: inline-block; 
            margin: 10px; 
            text-align: center; 
        }
        .image-test img { 
            max-width: 100px; 
            max-height: 100px; 
            border: 1px solid #ddd; 
        }
        .diagnosis { 
            font-size: 14px; 
            background: #fff3cd; 
            border: 1px solid #ffeaa7; 
            padding: 15px; 
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš¨ KPOP Ranker API ì§„ë‹¨ ë„êµ¬</h1>
        <p><strong>ëª©ì :</strong> ì•„í‹°ìŠ¤íŠ¸ ìƒì„¸ í˜ì´ì§€ ì•¨ë²” ì´ë¯¸ì§€ ë¬¸ì œë¥¼ ì •í™•íˆ ì§„ë‹¨í•©ë‹ˆë‹¤.</p>
        
        <div class="test-section">
            <h2>ğŸ” Step 1: ë°±ì—”ë“œ ê¸°ë³¸ ìƒíƒœ í™•ì¸</h2>
            <button onclick="testBackendBasic()">ë°±ì—”ë“œ ìƒíƒœ í…ŒìŠ¤íŠ¸</button>
            <div id="backend-result" class="result"></div>
        </div>
        
        <div class="test-section">
            <h2>ğŸµ Step 2: ì•„í‹°ìŠ¤íŠ¸ ì™„ì „ ì •ë³´ API í…ŒìŠ¤íŠ¸</h2>
            <button onclick="testArtistAPI('BLACKPINK')">BLACKPINK í…ŒìŠ¤íŠ¸</button>
            <button onclick="testArtistAPI('HUNTR/X')">HUNTR/X í…ŒìŠ¤íŠ¸</button>
            <button onclick="testArtistAPI('NewJeans')">NewJeans í…ŒìŠ¤íŠ¸</button>
            <div id="artist-result" class="result"></div>
        </div>
        
        <div class="test-section">
            <h2>ğŸ–¼ï¸ Step 3: ì•¨ë²” ì´ë¯¸ì§€ API í…ŒìŠ¤íŠ¸</h2>
            <button onclick="testImageAPI()">ì´ë¯¸ì§€ API í…ŒìŠ¤íŠ¸</button>
            <div id="image-result" class="result"></div>
            <div id="image-display"></div>
        </div>
        
        <div class="test-section">
            <h2>ğŸ”„ Step 4: í”„ë¡ íŠ¸ì—”ë“œ í”„ë¡ì‹œ í…ŒìŠ¤íŠ¸</h2>
            <button onclick="testFrontendProxy()">í”„ë¡ íŠ¸ì—”ë“œ í”„ë¡ì‹œ í…ŒìŠ¤íŠ¸</button>
            <div id="proxy-result" class="result"></div>
        </div>
        
        <div class="test-section">
            <h2>ğŸ“‹ Step 5: ì¢…í•© ì§„ë‹¨ ê²°ê³¼</h2>
            <button onclick="generateDiagnosis()">ì¢…í•© ì§„ë‹¨ ìƒì„±</button>
            <div id="diagnosis-result" class="result diagnosis"></div>
        </div>
    </div>

    <script>
        const BACKEND_URL = 'http://localhost:5000';
        const FRONTEND_URL = 'http://localhost:3007';
        
        let testResults = {
            backend: null,
            artist: {},
            image: {},
            proxy: null
        };
        
        function log(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            element.className = `result ${type}`;
            element.textContent += `[${timestamp}] ${message}\n`;
        }
        
        function clearLog(elementId) {
            document.getElementById(elementId).textContent = '';
            document.getElementById(elementId).className = 'result';
        }
        
        async function testBackendBasic() {
            clearLog('backend-result');
            log('backend-result', 'ğŸ” ë°±ì—”ë“œ ê¸°ë³¸ ìƒíƒœ í…ŒìŠ¤íŠ¸ ì‹œì‘...');
            
            try {
                const response = await fetch(`${BACKEND_URL}/`);
                log('backend-result', `ìƒíƒœ ì½”ë“œ: ${response.status}`, response.ok ? 'success' : 'error');
                
                if (response.ok) {
                    const text = await response.text();
                    log('backend-result', `ì‘ë‹µ ë‚´ìš©: ${text.substring(0, 200)}...`);
                    log('backend-result', 'âœ… ë°±ì—”ë“œ ì„œë²„ ì •ìƒ ì‘ë™', 'success');
                    testResults.backend = true;
                } else {
                    log('backend-result', 'âŒ ë°±ì—”ë“œ ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜', 'error');
                    testResults.backend = false;
                }
            } catch (error) {
                log('backend-result', `âŒ ë°±ì—”ë“œ ì—°ê²° ì‹¤íŒ¨: ${error.message}`, 'error');
                testResults.backend = false;
            }
        }
        
        async function testArtistAPI(artist) {
            clearLog('artist-result');
            log('artist-result', `ğŸµ ${artist} ì•„í‹°ìŠ¤íŠ¸ API í…ŒìŠ¤íŠ¸ ì‹œì‘...`);
            
            try {
                const url = `${BACKEND_URL}/api/artist/${encodeURIComponent(artist)}/complete`;
                log('artist-result', `ìš”ì²­ URL: ${url}`);
                
                const response = await fetch(url);
                log('artist-result', `ìƒíƒœ ì½”ë“œ: ${response.status}`, response.ok ? 'success' : 'error');
                
                if (response.ok) {
                    const data = await response.json();
                    const tracks = data.tracks || [];
                    
                    log('artist-result', `ì•„í‹°ìŠ¤íŠ¸: ${data.artist || 'ì—†ìŒ'}`);
                    log('artist-result', `ê³¡ ìˆ˜: ${tracks.length}`);
                    
                    if (tracks.length > 0) {
                        const firstTrack = tracks[0];
                        log('artist-result', `ì²« ë²ˆì§¸ ê³¡: ${firstTrack.name || 'ì—†ìŒ'}`);
                        log('artist-result', `ì•¨ë²” ì´ë¯¸ì§€: ${firstTrack.album_image || 'ì—†ìŒ'}`);
                        
                        // ì´ë¯¸ì§€ ìˆëŠ” ê³¡ ê°œìˆ˜ í™•ì¸
                        const tracksWithImages = tracks.filter(t => t.album_image && t.album_image !== 'ì—†ìŒ');
                        log('artist-result', `ì´ë¯¸ì§€ ìˆëŠ” ê³¡: ${tracksWithImages.length}/${tracks.length}`);
                        
                        testResults.artist[artist] = {
                            success: true,
                            trackCount: tracks.length,
                            imageCount: tracksWithImages.length,
                            firstTrackImage: firstTrack.album_image
                        };
                        
                        log('artist-result', 'âœ… ì•„í‹°ìŠ¤íŠ¸ API ì •ìƒ', 'success');
                    } else {
                        log('artist-result', 'âš ï¸ íŠ¸ë™ ì •ë³´ ì—†ìŒ', 'error');
                        testResults.artist[artist] = { success: false, reason: 'no tracks' };
                    }
                } else {
                    log('artist-result', `âŒ API í˜¸ì¶œ ì‹¤íŒ¨: HTTP ${response.status}`, 'error');
                    const errorText = await response.text();
                    log('artist-result', `ì˜¤ë¥˜ ë‚´ìš©: ${errorText.substring(0, 200)}`);
                    testResults.artist[artist] = { success: false, reason: `HTTP ${response.status}` };
                }
            } catch (error) {
                log('artist-result', `âŒ ìš”ì²­ ì˜¤ë¥˜: ${error.message}`, 'error');
                testResults.artist[artist] = { success: false, reason: error.message };
            }
        }
        
        async function testImageAPI() {
            clearLog('image-result');
            clearLog('image-display');
            log('image-result', 'ğŸ–¼ï¸ ì•¨ë²” ì´ë¯¸ì§€ API í…ŒìŠ¤íŠ¸ ì‹œì‘...');
            
            const imageTests = [
                ['BLACKPINK', 'Pink Venom'],
                ['BLACKPINK', 'JUMP'],
                ['HUNTR/X', 'Golden']
            ];
            
            const imageDisplay = document.getElementById('image-display');
            
            for (const [artist, track] of imageTests) {
                try {
                    const url = `${BACKEND_URL}/api/album-image/${encodeURIComponent(artist)}/${encodeURIComponent(track)}`;
                    log('image-result', `í…ŒìŠ¤íŠ¸: ${artist} - ${track}`);
                    log('image-result', `URL: ${url}`);
                    
                    const response = await fetch(url);
                    log('image-result', `ìƒíƒœ: ${response.status}`);
                    
                    if (response.ok || response.status === 304) {
                        const contentType = response.headers.get('Content-Type') || 'ì•Œ ìˆ˜ ì—†ìŒ';
                        const blob = await response.blob();
                        
                        log('image-result', `âœ… ì„±ê³µ - íƒ€ì…: ${contentType}, í¬ê¸°: ${blob.size} bytes`, 'success');
                        
                        // ì´ë¯¸ì§€ í‘œì‹œ
                        const imgContainer = document.createElement('div');
                        imgContainer.className = 'image-test';
                        
                        const img = document.createElement('img');
                        img.src = URL.createObjectURL(blob);
                        img.alt = `${artist} - ${track}`;
                        img.onload = () => URL.revokeObjectURL(img.src);
                        
                        const label = document.createElement('div');
                        label.textContent = `${artist} - ${track}`;
                        
                        imgContainer.appendChild(img);
                        imgContainer.appendChild(label);
                        imageDisplay.appendChild(imgContainer);
                        
                        testResults.image[`${artist}-${track}`] = { success: true, size: blob.size };
                    } else {
                        log('image-result', `âŒ ì‹¤íŒ¨: HTTP ${response.status}`, 'error');
                        testResults.image[`${artist}-${track}`] = { success: false, status: response.status };
                    }
                } catch (error) {
                    log('image-result', `âŒ ì˜¤ë¥˜: ${error.message}`, 'error');
                    testResults.image[`${artist}-${track}`] = { success: false, error: error.message };
                }
            }
        }
        
        async function testFrontendProxy() {
            clearLog('proxy-result');
            log('proxy-result', 'ğŸ”„ í”„ë¡ íŠ¸ì—”ë“œ í”„ë¡ì‹œ í…ŒìŠ¤íŠ¸ ì‹œì‘...');
            
            try {
                // í”„ë¡ íŠ¸ì—”ë“œë¥¼ í†µí•œ ë°±ì—”ë“œ API í˜¸ì¶œ
                const proxyUrl = `${FRONTEND_URL}/api/artist/BLACKPINK/complete`;
                log('proxy-result', `í”„ë¡ì‹œ URL: ${proxyUrl}`);
                
                const response = await fetch(proxyUrl);
                log('proxy-result', `í”„ë¡ì‹œ ìƒíƒœ: ${response.status}`);
                
                if (response.ok) {
                    const data = await response.json();
                    log('proxy-result', `âœ… í”„ë¡ íŠ¸ì—”ë“œ í”„ë¡ì‹œ ì •ìƒ ì‘ë™`, 'success');
                    log('proxy-result', `ì•„í‹°ìŠ¤íŠ¸: ${data.artist || 'ì—†ìŒ'}`);
                    log('proxy-result', `ê³¡ ìˆ˜: ${(data.tracks || []).length}`);
                    testResults.proxy = true;
                } else {
                    log('proxy-result', `âŒ í”„ë¡ì‹œ ì‹¤íŒ¨: HTTP ${response.status}`, 'error');
                    log('proxy-result', 'â†’ ì´ê²ƒì´ ë¬¸ì œì˜ ì›ì¸ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤!', 'error');
                    testResults.proxy = false;
                }
            } catch (error) {
                log('proxy-result', `âŒ í”„ë¡ì‹œ ì—°ê²° ì˜¤ë¥˜: ${error.message}`, 'error');
                log('proxy-result', 'â†’ Next.js í”„ë¡ì‹œ ì„¤ì • ë¬¸ì œ ê°€ëŠ¥ì„±', 'error');
                testResults.proxy = false;
            }
        }
        
        function generateDiagnosis() {
            clearLog('diagnosis-result');
            
            const diagnosis = document.getElementById('diagnosis-result');
            diagnosis.className = 'result diagnosis';
            
            let report = 'ğŸ¥ KPOP Ranker ì¢…í•© ì§„ë‹¨ ë³´ê³ ì„œ\\n';
            report += '='.repeat(50) + '\\n\\n';
            
            // ë°±ì—”ë“œ ìƒíƒœ
            if (testResults.backend === true) {
                report += 'âœ… ë°±ì—”ë“œ ì„œë²„: ì •ìƒ ì‘ë™\\n';
            } else if (testResults.backend === false) {
                report += 'âŒ ë°±ì—”ë“œ ì„œë²„: ë¬¸ì œ ìˆìŒ\\n';
            } else {
                report += 'âš ï¸ ë°±ì—”ë“œ ì„œë²„: í…ŒìŠ¤íŠ¸ ì•ˆí•¨\\n';
            }
            
            // ì•„í‹°ìŠ¤íŠ¸ API ìƒíƒœ
            const artistTests = Object.keys(testResults.artist);
            if (artistTests.length > 0) {
                const successCount = artistTests.filter(a => testResults.artist[a].success).length;
                report += `âœ… ì•„í‹°ìŠ¤íŠ¸ API: ${successCount}/${artistTests.length} ì„±ê³µ\\n`;
                
                for (const artist of artistTests) {
                    const result = testResults.artist[artist];
                    if (result.success) {
                        report += `   ${artist}: ${result.imageCount}/${result.trackCount} ê³¡ì— ì´ë¯¸ì§€\\n`;
                    } else {
                        report += `   ${artist}: ì‹¤íŒ¨ (${result.reason})\\n`;
                    }
                }
            } else {
                report += 'âš ï¸ ì•„í‹°ìŠ¤íŠ¸ API: í…ŒìŠ¤íŠ¸ ì•ˆí•¨\\n';
            }
            
            // ì´ë¯¸ì§€ API ìƒíƒœ
            const imageTests = Object.keys(testResults.image);
            if (imageTests.length > 0) {
                const successCount = imageTests.filter(i => testResults.image[i].success).length;
                report += `âœ… ì´ë¯¸ì§€ API: ${successCount}/${imageTests.length} ì„±ê³µ\\n`;
            } else {
                report += 'âš ï¸ ì´ë¯¸ì§€ API: í…ŒìŠ¤íŠ¸ ì•ˆí•¨\\n';
            }
            
            // í”„ë¡ì‹œ ìƒíƒœ
            if (testResults.proxy === true) {
                report += 'âœ… í”„ë¡ íŠ¸ì—”ë“œ í”„ë¡ì‹œ: ì •ìƒ ì‘ë™\\n';
            } else if (testResults.proxy === false) {
                report += 'âŒ í”„ë¡ íŠ¸ì—”ë“œ í”„ë¡ì‹œ: ë¬¸ì œ ìˆìŒ\\n';
            } else {
                report += 'âš ï¸ í”„ë¡ íŠ¸ì—”ë“œ í”„ë¡ì‹œ: í…ŒìŠ¤íŠ¸ ì•ˆí•¨\\n';
            }
            
            report += '\\n' + '='.repeat(50) + '\\n';
            
            // ë¬¸ì œ ì§„ë‹¨
            if (testResults.backend === false) {
                report += 'ğŸš¨ ì£¼ìš” ë¬¸ì œ: ë°±ì—”ë“œ ì„œë²„ê°€ ì‘ë™í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤\\n';
                report += 'ğŸ’¡ í•´ê²° ë°©ë²•: ë°±ì—”ë“œ ì„œë²„ë¥¼ ì¬ì‹œì‘í•˜ì„¸ìš”\\n';
                report += '   python main.py\\n';
            } else if (testResults.proxy === false) {
                report += 'ğŸš¨ ì£¼ìš” ë¬¸ì œ: í”„ë¡ íŠ¸ì—”ë“œ í”„ë¡ì‹œê°€ ì‘ë™í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤\\n';
                report += 'ğŸ’¡ í•´ê²° ë°©ë²•: ë‹¤ìŒ ì¤‘ í•˜ë‚˜ë¥¼ ì‹œë„í•˜ì„¸ìš”\\n';
                report += '   1. í”„ë¡ íŠ¸ì—”ë“œ ì„œë²„ ì¬ì‹œì‘\\n';
                report += '   2. apiConfig.tsì—ì„œ ì§ì ‘ ë°±ì—”ë“œ í˜¸ì¶œë¡œ ë³€ê²½\\n';
                report += '   3. CORS ì„¤ì • í™•ì¸\\n';
            } else if (Object.values(testResults.artist).some(r => r.success && r.imageCount === 0)) {
                report += 'ğŸš¨ ì£¼ìš” ë¬¸ì œ: ì•¨ë²” ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤\\n';
                report += 'ğŸ’¡ í•´ê²° ë°©ë²•: ì´ë¯¸ì§€ íŒŒì¼ ìƒì„± ë° ê²½ë¡œ í™•ì¸\\n';
            } else if (Object.values(testResults.image).some(r => !r.success)) {
                report += 'ğŸš¨ ì£¼ìš” ë¬¸ì œ: ì´ë¯¸ì§€ APIê°€ ì‘ë™í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤\\n';
                report += 'ğŸ’¡ í•´ê²° ë°©ë²•: ì´ë¯¸ì§€ íŒŒì¼ ê²½ë¡œ í™•ì¸\\n';
            } else {
                report += 'ğŸ‰ ëª¨ë“  ì‹œìŠ¤í…œì´ ì •ìƒ ì‘ë™í•©ë‹ˆë‹¤!\\n';
                report += 'ğŸ’¡ ë¸Œë¼ìš°ì € ìºì‹œë¥¼ ì§€ìš°ê±°ë‚˜ ê°•ì œ ìƒˆë¡œê³ ì¹¨ (Ctrl+F5)ì„ ì‹œë„í•˜ì„¸ìš”\\n';
            }
            
            diagnosis.textContent = report;
        }
    </script>
</body>
</html>
