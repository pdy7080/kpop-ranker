import React, { useState, useEffect } from 'react';
import Image from 'next/image';
import { apiUrls, API_CONFIG } from '@/lib/apiConfig';

interface ImageWithFallbackProps {
  src: string;
  alt: string;
  width?: number;
  height?: number;
  className?: string;
  fill?: boolean;
  artistName?: string;
  trackName?: string;
  priority?: boolean;
  unoptimized?: boolean;
}

/**
 * ğŸ”§ ì™„ì „ ìˆ˜ì •ëœ ì´ë¯¸ì§€ í´ë°± ì»´í¬ë„ŒíŠ¸
 * 
 * ìˆ˜ì •ì‚¬í•­:
 * 1. currentSrc ì´ˆê¸°í™” ë¬¸ì œ í•´ê²°
 * 2. ë°±ì—”ë“œ API v2 ì§ì ‘ ì‚¬ìš©
 * 3. í•œê¸€ ì•„í‹°ìŠ¤íŠ¸ëª… ì™„ë²½ ì§€ì›
 */
const ImageWithFallback: React.FC<ImageWithFallbackProps> = ({
  src,
  alt,
  width = 128,
  height = 128,
  className = '',
  fill = false,
  artistName = '',
  trackName = '',
  priority = false,
  unoptimized = true
}) => {
  const [currentSrc, setCurrentSrc] = useState<string>('');
  const [fallbackIndex, setFallbackIndex] = useState(0);
  const [isLoading, setIsLoading] = useState(true);
  const [hasError, setHasError] = useState(false);

  // í´ë°± URL ë°°ì—´ ìƒì„± (ë°±ì—”ë“œ ì‹¤ì œ ê²½ë¡œ ê¸°ë°˜)
  const generateFallbackUrls = (): string[] => {
    const baseUrl = process.env.NEXT_PUBLIC_API_URL || 'http://localhost:5000';
    const urls: string[] = [];
    
    // 1ìˆœìœ„: v2 API (ì•„í‹°ìŠ¤íŠ¸ + íŠ¸ë™)
    if (artistName && trackName) {
      urls.push(`${baseUrl}/api/album-image-v2/${encodeURIComponent(artistName)}/${encodeURIComponent(trackName)}`);
    }
    
    // 2ìˆœìœ„: v2 API (ì•„í‹°ìŠ¤íŠ¸ë§Œ)
    if (artistName) {
      urls.push(`${baseUrl}/api/album-image-v2/${encodeURIComponent(artistName)}`);
    }
    
    // 3ìˆœìœ„: ì•„í‹°ìŠ¤íŠ¸ ì²« ê¸€ì ê¸°ë³¸ ì´ë¯¸ì§€ (ë°±ì—”ë“œì— ì‹¤ì œ ì¡´ì¬í•˜ëŠ” íŒŒì¼ë“¤)
    if (artistName) {
      const firstChar = artistName.charAt(0);
      
      // í•œê¸€ ë§µí•‘ (ë°±ì—”ë“œ íŒŒì¼ ê¸°ì¤€)
      const koreanMapping: { [key: string]: string } = {
        'ì„': 'ì„',  // ì„ì˜ì›… â†’ ì„.jpg (ë°±ì—”ë“œì— ì¡´ì¬)
        'ì•„': 'ì•„',  // ì•„ì´ìœ  â†’ ì•„.jpg  
        'ë‰´': 'N',   // ë‰´ì§„ìŠ¤ â†’ N.jpg
        'ë¸”': 'B',   // ë¸”ë™í•‘í¬ â†’ B.jpg
        'ì„¸': 'ì„¸',  // ì„¸ë¸í‹´ â†’ ì„¸.jpg
        'íŠ¸': 'íŠ¸',  // íŠ¸ì™€ì´ìŠ¤ â†’ íŠ¸.jpg
        'ìŠ¤': 'ìŠ¤',  // ìŠ¤í‚¤ì¦ˆ â†’ ìŠ¤.jpg
        'K': 'K',
        'H': 'H',
        'A': 'A',
        'B': 'B',
        'C': 'C',
        'D': 'D',
        'E': 'E',
        'F': 'F',
        'G': 'G',
        'I': 'I',
        'J': 'J',
        'L': 'L',
        'M': 'M',
        'N': 'N',
        'O': 'O',
        'P': 'P',
        'Q': 'Q',
        'R': 'R',
        'S': 'S',
        'T': 'T',
        'U': 'U',
        'W': 'W'
      };
      
      const mappedChar = koreanMapping[firstChar] || firstChar.toUpperCase();
      if (mappedChar) {
        urls.push(`${baseUrl}/static/default_images/${mappedChar}.jpg`);
      }
    }
    
    // 4ìˆœìœ„: ìµœì¢… ê¸°ë³¸ ì´ë¯¸ì§€
    urls.push(`${baseUrl}/static/default_images/default.jpg`);
    
    console.log('ğŸ–¼ï¸ ìƒì„±ëœ í´ë°± URLs:', urls);
    return urls;
  };

  // ì´ˆê¸° URL ì„¤ì •
  useEffect(() => {
    const fallbackUrls = generateFallbackUrls();
    if (fallbackUrls.length > 0) {
      console.log('ğŸ–¼ï¸ ì²« ë²ˆì§¸ URL ì„¤ì •:', fallbackUrls[0]);
      setCurrentSrc(fallbackUrls[0]);
      setFallbackIndex(0);
      setIsLoading(true);
      setHasError(false);
    }
  }, [artistName, trackName]);

  // ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨ ì‹œ ë‹¤ìŒ í´ë°±ìœ¼ë¡œ ì „í™˜
  const handleError = () => {
    const fallbackUrls = generateFallbackUrls();
    const nextIndex = fallbackIndex + 1;
    
    console.log(`ğŸ–¼ï¸ ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨, í´ë°± ì‹œë„: ${nextIndex}/${fallbackUrls.length}`);
    
    if (nextIndex < fallbackUrls.length) {
      setFallbackIndex(nextIndex);
      setCurrentSrc(fallbackUrls[nextIndex]);
      console.log(`ğŸ–¼ï¸ í´ë°± ${nextIndex + 1}/${fallbackUrls.length}: ${fallbackUrls[nextIndex]}`);
    } else {
      console.warn('ğŸ–¼ï¸ ëª¨ë“  ì´ë¯¸ì§€ í´ë°± ì‹¤íŒ¨:', { artistName, trackName });
      setHasError(true);
      setIsLoading(false);
    }
  };

  // ì´ë¯¸ì§€ ë¡œë“œ ì„±ê³µ ì‹œ
  const handleLoad = () => {
    console.log('âœ… ì´ë¯¸ì§€ ë¡œë“œ ì„±ê³µ:', currentSrc);
    setIsLoading(false);
    setHasError(false);
  };

  // ëª¨ë“  í´ë°± ì‹¤íŒ¨ ì‹œ í…ìŠ¤íŠ¸ í”Œë ˆì´ìŠ¤í™€ë”
  if (hasError || (!isLoading && !currentSrc)) {
    const displayChar = artistName ? artistName.charAt(0).toUpperCase() : 'â™ª';
    
    return (
      <div 
        className={`bg-gradient-to-br from-purple-500 to-blue-600 flex items-center justify-center text-white font-bold text-2xl ${className}`}
        style={{ width, height, objectFit: 'cover' }}
      >
        {displayChar}
      </div>
    );
  }

  // ë¡œë”© ì¤‘ì¼ ë•Œ ìŠ¤ì¼ˆë ˆí†¤
  if (isLoading && !currentSrc) {
    return (
      <div 
        className={`bg-gray-200 animate-pulse flex items-center justify-center ${className}`}
        style={{ width, height }}
      >
        <div className="text-gray-400">...</div>
      </div>
    );
  }

  const imageProps = {
    src: currentSrc,
    alt: alt || `${artistName}${trackName ? ` - ${trackName}` : ''} ì•¨ë²” ì´ë¯¸ì§€`,
    className: `${className} transition-opacity duration-200`,
    onError: handleError,
    onLoad: handleLoad,
    priority,
    unoptimized: true,
    style: { objectFit: 'cover' as const },
    width: fill ? undefined : width,
    height: fill ? undefined : height
  };

  if (fill) {
    return <Image {...imageProps} fill />;
  }

  return <Image {...imageProps} />;
};

export default ImageWithFallback;